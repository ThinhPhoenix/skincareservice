@page "/staff/services"
@using SkinCareBussinessObject
@using SkinCareRepository
@using System.Linq
@inject IServiceRepository ServiceRepository
@inject IServiceCategoryRepository CategoryRepository
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<h3 class="text-2xl font-semibold text-center mb-6">Skin Care Services</h3>

@if (errorMessage != null)
{
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-center mb-4">
        @errorMessage
    </div>
}

@if (serviceList == null)
{
    <div class="text-center text-gray-500">
        <p><em>Loading...</em></p>
    </div>
}
else
{
    <div class="flex justify-between items-center mb-6">
        <div class="flex space-x-4 items-center">
            <div class="relative">
                <input type="text" class="pl-10 pr-4 py-2 border rounded-md focus:ring-primary focus:border-primary" 
                       placeholder="Tìm kiếm dịch vụ..." @bind="searchKeyword" @bind:event="oninput" @onkeyup="HandleSearchKeyUp" />
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <button class="bg-blue-500 text-white px-4 py-2 rounded-md shadow-md hover:bg-blue-600 transition"
                    @onclick="SearchServices">
                Tìm kiếm
            </button>
            <button class="bg-gray-500 text-white px-4 py-2 rounded-md shadow-md hover:bg-gray-600 transition"
                    @onclick="ResetSearch">
                Reset
            </button>
        </div>

        <button class="bg-primary text-white px-4 py-2 rounded-md shadow-md hover:bg-primary/80 transition" @onclick="AddNewService">
            + Add New Service
        </button>
    </div>

    <div class="overflow-hidden rounded-lg border border-gray-200 shadow-sm">
        <table class="w-full border-collapse bg-white text-sm">
            <thead class="bg-gray-100 text-gray-700 uppercase">
                <tr>
                    <th class="px-4 py-2 text-left">Service Name</th>
                    <th class="px-4 py-2 text-left">Category</th>
                    <th class="px-4 py-2 text-left">Description</th>
                    <th class="px-4 py-2 text-right">Price</th>
                    <th class="px-4 py-2 text-center">Duration</th>
                    <th class="px-4 py-2 text-center">Status</th>
                    <th class="px-4 py-2 text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y">
                @foreach (var service in displayedServices ?? Enumerable.Empty<Service>())
                {
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">@service.ServiceName</td>
                        <td class="px-4 py-3">@(service.ServiceCategory?.CategoryName ?? "N/A")</td>
                        <td class="px-4 py-3">@(string.IsNullOrEmpty(service.Description) ? "N/A" : service.Description)</td>
                        <td class="px-4 py-3 text-right">$@service.Price.ToString("F2")</td>
                        <td class="px-4 py-3 text-center">@service.DurationMinutes min</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 text-xs font-semibold rounded-md @(service.IsActive ? "bg-green-100 text-green-700" : "bg-red-100 text-red-700")">
                                @(service.IsActive ? "Active" : "Inactive")
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center space-x-2">
                                <button class="bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 transition" @onclick="() => EditService(service.Id)">Edit</button>
                                <button class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition" @onclick="() => DeleteService(service.Id)">Delete</button>
                                <button class="bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600 transition" @onclick="() => ViewServiceDetails(service.Id)">View</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (displayedServices?.Any() != true)
    {
        <div class="text-center my-8 text-gray-500">
            <p>Không tìm thấy dịch vụ nào phù hợp.</p>
        </div>
    }
}

@code {
    private List<Service>? serviceList;
    private List<Service>? displayedServices;
    private string searchKeyword = "";
    private string? errorMessage;
    private System.Threading.Timer? searchTimer;

    protected override void OnInitialized()
    {
        try
        {
            LoadServices();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading services: {ex.Message}";
        }
    }

    protected override void OnParametersSet()
    {
        try
        {
            LoadServices();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading services: {ex.Message}";
        }
    }

    private void LoadServices()
    {
        serviceList = ServiceRepository.GetAll();
        displayedServices = serviceList;

        foreach (var service in serviceList ?? Enumerable.Empty<Service>())
        {
            if (service.CategoryId != null && service.ServiceCategory == null)
            {
                service.ServiceCategory = CategoryRepository.GetOne(service.CategoryId);
            }
        }
    }

    private async Task DeleteService(string id)
    {
        try
        {
            var confirmDelete = await JSRuntime.InvokeAsync<bool>("confirm", "Bạn có chắc chắn muốn xóa dịch vụ này?");
            if (!confirmDelete)
            {
                return;
            }

            ServiceRepository.Delete(id);
            serviceList?.RemoveAll(s => s.Id == id);
            displayedServices = new List<Service>(displayedServices?.Where(s => s.Id != id) ?? Enumerable.Empty<Service>());
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting service: {ex.Message}";
        }
    }

    private void SearchServices()
    {
        try
        {
            errorMessage = null;
            
            if (string.IsNullOrWhiteSpace(searchKeyword))
            {
                displayedServices = serviceList;
                return;
            }

            displayedServices = ServiceRepository.Search(searchKeyword);
            
            // Cập nhật thông tin danh mục
            foreach (var service in displayedServices ?? Enumerable.Empty<Service>())
            {
                if (service.CategoryId != null && service.ServiceCategory == null)
                {
                    service.ServiceCategory = CategoryRepository.GetOne(service.CategoryId);
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error searching services: {ex.Message}";
        }
    }

    private void HandleSearchKeyUp(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            SearchServices();
        }
        
        // Debounce search
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                if (searchKeyword.Length >= 2)
                {
                    SearchServices();
                    StateHasChanged();
                }
            });
        }, null, 500, Timeout.Infinite);
    }

    private void ResetSearch()
    {
        searchKeyword = "";
        displayedServices = serviceList;
        errorMessage = null;
    }

    private void AddNewService()
    {
        NavigationManager.NavigateTo("staff/services/add");
    }

    private void EditService(string id)
    {
        NavigationManager.NavigateTo("staff/services/edit/" + id);
    }

    private void ViewServiceDetails(string id)
    {
        NavigationManager.NavigateTo("staff/services/details/" + id);
    }
}